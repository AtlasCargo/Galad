name: ci

on:
  push:
  pull_request:

jobs:
  validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt
      - name: Install dependencies
        if: hashFiles('requirements.txt') != ''
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Report changed files
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_BASE: ${{ github.event.pull_request.base.sha }}
          PR_HEAD: ${{ github.event.pull_request.head.sha }}
          PUSH_BASE: ${{ github.event.before }}
          PUSH_HEAD: ${{ github.sha }}
        run: |
          set -euo pipefail
          echo "Changed files:"
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            base="$PR_BASE"
            head="$PR_HEAD"
          else
            base="$PUSH_BASE"
            head="$PUSH_HEAD"
          fi
          if [[ -z "$base" || "$base" =~ ^0+$ ]]; then
            git ls-tree --name-only -r "$head"
          else
            git diff --name-only "$base" "$head"
          fi
      - name: Validate Python syntax
        if: hashFiles('scripts/*.py') != ''
        run: python -m compileall -q scripts
      - name: Validate outputs
        if: hashFiles('scripts/validate_outputs.py') != ''
        run: python scripts/validate_outputs.py
